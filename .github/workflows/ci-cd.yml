name: CI/CD Auto Pull and Rebuild

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy-hasryl:
    runs-on: [hasryl]
    timeout-minutes: 30

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set project path
      run: |
        PROJECT_PATH="/mnt/c/belajar-spring/spring_project"
        echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
        echo "üìÅ Project path: $PROJECT_PATH"

    - name: Ensure clean working directory
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Clean any untracked files
        git clean -fd || true
        # Reset to match remote
        git reset --hard origin/master || true

    - name: Clean Docker resources
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Remove old containers
        docker compose down -v || true

        # Kill any process using port 80
        sudo fuser -k 80/tcp || true
        sleep 5

        # Clean up dangling images and containers
        docker system prune -f

        # Remove project-specific images only
        docker images | grep "transaksi\|nginx" | awk '{print $3}' | xargs -r docker rmi -f || true

    - name: Build and start containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Build with no cache
        docker compose build --no-cache

        # Start in detached mode
        docker compose up -d

        echo "‚úÖ Containers started"

    - name: Wait for services to be ready
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "‚è≥ Waiting for services to initialize..."
        sleep 10

        # Wait for MySQL to be healthy
        echo "Checking MySQL health..."
        for i in {1..30}; do
          if docker compose exec -T mysql mysqladmin ping -h localhost -uroot -p1234 --silent 2>/dev/null; then
            echo "‚úÖ MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done

        # Wait for Spring Boot app
        echo "Checking Spring Boot app..."
        sleep 5

        # Show container status
        docker compose ps

        # Show logs if there are issues
        echo "üìã Container logs:"
        docker compose logs --tail=50

    - name: Verify containers are running
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Check if all containers are up
        if ! docker compose ps | grep -q "Up"; then
          echo "‚ùå Some containers are not running!"
          docker compose logs
          exit 1
        fi
        echo "‚úÖ All containers are running"

    - name: Health check
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "üîç Running health checks..."

        # Wait a bit more for Nginx and app to be fully ready
        sleep 5

        # Check via Nginx on port 80
        if curl -s -o /dev/null -w "%{http_code}" http://localhost/api/barang | grep -q "200"; then
          echo "‚úÖ Health check passed (HTTP 200 on /api/barang via Nginx)"
        else
          echo "‚ö†Ô∏è Health check warning - checking details..."

          # Show more details
          echo "Curl response:"
          curl -v http://localhost/api/barang || true

          echo ""
          echo "Nginx logs:"
          docker compose logs nginx --tail=20

          echo ""
          echo "App logs:"
          docker compose logs app --tail=20

          echo ""
          echo "MySQL logs:"
          docker compose logs mysql --tail=20

          exit 1
        fi

    - name: Deployment Summary
      if: always()
      run: |
        PROJECT_PATH="/mnt/c/belajar-spring/spring_project"
        echo "üìä Deployment Summary"
        echo "===================="
        echo ""
        echo "Container Status:"
        docker compose ps
        echo ""
        echo "Port Mappings:"
        docker compose port nginx 80 || echo "Nginx port not exposed"
        echo ""
        echo "‚úÖ Deployment completed for runner: fatur"

