name: CI/CD Auto Pull and Rebuild
# hello
on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy-hasryl:
    runs-on: [hasryl]
    timeout-minutes: 30

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set project path
      run: |
        PROJECT_PATH="/mnt/c/belajar-spring/spring_project"
        echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
        echo "üìÅ Project path: $PROJECT_PATH"

    - name: Ensure clean working directory
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Clean any untracked files
        git clean -fd || true
        # Reset to match remote
        git reset --hard origin/master || true

    - name: Clean Docker resources
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Remove old containers with timeout
        timeout 30 docker compose down -v || true

          # Wait for the app container to report as Up
          for i in {1..30}; do
            echo "Checking containers (attempt $i/30)..."
            docker compose ps || true
            if docker compose ps | grep -E "app.*Up" >/dev/null 2>&1; then
              echo "‚úÖ app container is Up"
              break
            fi
            sleep 2
          done

          # First try host-level request (port mapping)
          for i in {1..6}; do
            echo "Host curl attempt $i/6..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/barang 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed (HTTP $HTTP_CODE via host port 8080)"
              exit 0
            fi
            sleep 2
          done

          # If host-level check fails, try an in-container request (avoids host networking/port mapping issues)
          echo "Host-level check failed; trying in-container request..."
          IN_CONTAINER_CODE=$(docker compose exec -T app sh -c 'curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/barang' 2>/dev/null || echo "000")
          if [ "$IN_CONTAINER_CODE" = "200" ]; then
            echo "‚úÖ Health check passed (HTTP $IN_CONTAINER_CODE from inside container)"
            exit 0
          fi

          # Final failure: print verbose info
          echo "‚ùå Health check failed (host=$HTTP_CODE, in-container=$IN_CONTAINER_CODE)"
          echo "\nVerbose host curl output:"
          curl -v http://localhost:8080/api/barang || true

          echo "\nDocker compose ps:"
          docker compose ps || true

          echo "\nApp logs:"
          docker compose logs app --tail=50 || true

          echo "\nMySQL logs:"
          docker compose logs mysql --tail=50 || true

          exit 1
        echo "‚è≥ Waiting for services to initialize..."
        sleep 10

        # Wait for MySQL to be healthy
        echo "Checking MySQL health..."
        for i in {1..30}; do
          if docker compose exec -T mysql mysqladmin ping -h localhost -uroot -p1234 --silent 2>/dev/null; then
            echo "‚úÖ MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done

        # Wait for Spring Boot app
        echo "Checking Spring Boot app..."
        sleep 5

        # Show container status
        docker compose ps

        # Show logs if there are issues
        echo "üìã Container logs:"
        docker compose logs --tail=50

    - name: Verify containers are running
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Check if all containers are up
        if ! docker compose ps | grep -q "Up"; then
          echo "‚ùå Some containers are not running!"
          docker compose logs
          exit 1
        fi
        echo "‚úÖ All containers are running"

    - name: Health check
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "üîç Running health checks..."

        # Wait for app to be ready on port 8080 with retries
        for i in {1..30}; do
          echo "Health check attempt $i/30..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/barang 2>/dev/null || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Health check passed (HTTP $HTTP_CODE on /api/barang)"
            exit 0
          fi
          
          if [ $i -lt 30 ]; then
            echo "‚è≥ App not ready yet (HTTP $HTTP_CODE), waiting..."
            sleep 2
          fi
        done

        # If we get here, health check failed
        echo "‚ùå Health check failed after 30 attempts"
        echo ""
        echo "Attempting curl with verbose output:"
        curl -v http://localhost:8080/api/barang || true

        echo ""
        echo "App logs:"
        docker compose logs app --tail=30

        echo ""
        echo "MySQL logs:"
        docker compose logs mysql --tail=30

        exit 1

    - name: Deployment Summary
      if: always()
      run: |
        PROJECT_PATH="/mnt/c/belajar-spring/spring_project"
        echo "üìä Deployment Summary"
        echo "===================="
        echo ""
        echo "Container Status:"
        docker compose ps
        echo ""
        echo "Port Mappings:"
        docker compose port app 8080 || echo "App port not exposed"
        echo ""
        echo "‚úÖ Deployment completed for runner: fatur"

